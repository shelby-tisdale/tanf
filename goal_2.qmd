---
title: "Goal 2"
author: "Shelby Tisdale"
format: html
editor: visual
---

# Load Data and Packages

```{r}
#| label: load-packages
library(tidyverse)
library(data.table)
library(bit64)
library(janitor)
library(gt)
library(gtsummary)
```

```{r}
#| label: load-full-data
all_goals <- read_csv("data/sipp_all_goals.csv")
```

# Description

**Goal 2:** End the dependence of needy parents on government benefits by promoting job preparation, work, and marriage.

**Participant Households:** All households who received government benefits in the earliest year of their participation in the study.

**Criteria:** Goal 2 is fulfilled for a participant household if household members are no longer receiving government benefits by the end of the reference frame. Variables related to job preparation, work, and marriage will be used as predictors.

## Aggregate Dataset

**Questions:**

-   percent of unobligated funds changes by year, what do I do with that?
-   maybe instead of a binary outcome, we could create a type of "**success rate**" variable that could be modeled, the average for each household over the years.
-   To disregard the longitudianl component of the data, we are making a simplifying assumption that the percent of unobligated funds in one year is independent of the the percent in another year (for the same state) - each state-year combo is a separate group in the hierarchy. According to the visualization below, that kind of independence doesn't seem to be the case.
-   We could use year as a separate grouping variable OR use a state-year grouping structure?
    -   changing success rate to outcome?
-   Should my total TANF variable be some kind of ratio of total tanf received to number of years in the study?
    -   average tanf per year
-   **Note:** include variable for time participating in study

```{r}
#| label: aggregate-goal-2

# calculate number of years each person is in study
hh_years <- all_goals |>
  select(household_id, state, year) |>
  distinct() |>
  count(household_id) |>
  rename(n_years = n)

# create marriage variable
hh_marriage_yr <- all_goals |>
  select(household_id, state, month, fiscal_year, hh_married_month, in_goal2) |>
  filter(month == 10 & !is.na(hh_married_month) & in_goal2 == 1) |>
  distinct() |>
  rename(hh_married_yr = hh_married_month) |>
  select(household_id, state, fiscal_year, hh_married_yr)

goal2 <- all_goals |>
  # select goal 2 participants
  filter(in_goal2 == 1) |>
  # relevant variables for goal 2
  select(household_id, state, fiscal_year, pct_unobligated, party, goal2, received_job_training, tanf_amt_received) |>
  # change job training variable to numeric
  mutate(received_job_training = if_else(received_job_training == "0", 0, 1)) |>
  # add variable for number of years household is in study
  left_join(hh_years, join_by("household_id")) |>
  # calculate total tanf received for each household for each year
  # aggregates data to hh-state-year level
  group_by(household_id, state, fiscal_year, pct_unobligated, party, received_job_training, goal2, n_years) |>
  summarize(total_hh_tanf = sum(tanf_amt_received, na.rm = TRUE)) |>
  ungroup() |>
  left_join(hh_marriage_yr, join_by("household_id", "state", "fiscal_year"))
  group_by(state, fiscal_year, pct_unobligated, party) |>
  summarize(
    pct_goal2 = mean(goal2),
    pct_job_prep = mean(received_job_training),
    #pct_married = mean(hh_marriage_yr),
    # revisit mean tanf variable
    mean_hh_tanf = mean(total_hh_tanf),
    med_n_years = median(n_years)
    ) |>
  ungroup()
  
```

## Table 1

## EDA

```{r}
#| label: eda-goal-2

# histogram of goal 2 achievement rate (state-year)
sipp_goal2 |>
  mutate(goal2 = if_else(goal2 == "1", 1, 0)) |>
  group_by(state, fiscal_year) |>
  summarize(goal2_rate = mean(goal2)) |>
  ggplot(aes(x = goal2_rate)) +
  geom_histogram() +
  labs(x = "goal 2 success rate by state and year",
       y = "Count")

# histogram of goal 2 achievement rate (state only)
sipp_goal2 |>
  mutate(goal2 = if_else(goal2 == "1", 1, 0)) |>
  group_by(state) |>
  summarize(goal2_rate = mean(goal2)) |>
  ggplot(aes(x = goal2_rate)) +
  geom_histogram() +
  labs(x = "goal 2 success rate by state",
       y = "Count")

# line graph - percent unobligated funds 2017-2021
# grouped by state
# there is variation from year-to-year
# needs to be accounted for in model
sipp_goal2 |>
  mutate(goal2 = if_else(goal2 == "1", 1, 0)) |>
  ggplot(aes(x = fiscal_year, group = state, y = pct_unobligated)) +
  geom_line() +
  facet_wrap(~state) +
  theme_minimal() +
  labs(x = "fiscal year", y = "percent unobligated funds")

# gives sample size for each state
goal2_hh_per_state <- sipp_goal2 |>
  select(state, household_id) |>
  distinct() |>
  group_by(state) |>
  count()

sipp_goal2 |>
  mutate(goal2 = if_else(goal2 == "1", 1, 0)) |>
  group_by(state, fiscal_year, pct_unobligated, party) |>
  summarize(goal2_rate = mean(goal2)) |>
  ggplot(aes(x = pct_unobligated, y = goal2_rate, color = party)) +
  geom_point()
```

## Modeling

Let $Y_{ij2}$ denote whether or not household $i$ in state $j$ met the criteria for Goal 2.

$$ Y_{ij2} = \begin{cases} 1 & \text{yes} \\ 0 & \text{no} \end{cases} $$

$$ X_{ij1} = \text{whether householder i in state j is married at end of reference frame} \\ X_{ij2} = \text{whether householder i in state j participated in job preparation} \\ X_{ij3} = \text{whether householder i in state j is employed at end of reference frame} \\ X_{ij4} = \text{amount of TANF funds received by household i in state j during reference period} \\ X_{j5} = \text{percent of unobligated funds for state j} $$

Let $\pi_{ij}$ be the probability that household $i$ fulfills Goal 2. Then, $Y_{ij2}|\pi_{ij} \sim \text{Bern}(\pi_{ij})$.

We are using a **random intercepts logistic regression model.**

Model within state j:

$$ Y_{ij2}|\beta_{0j}, \beta_1, \beta_2, \beta_3, \beta_4, \beta_5 \sim \text{Bern}(\pi_{ij}) \\ \text{ with } \log(\frac{\pi_{ij}}{1-\pi_{ij}}) = \beta_{0j} +  \beta_1X_{ij1} + \beta_2X_{ij2} + \beta_3X_{ij3} + \beta_4X_{ij4} + \beta_5X_j $$

Variability between states:

**Assumptions**

-   The state-specific intercepts $B_{0j}$ describe the underlying achievement rates, as measured by the log odds of goal achievement for each state $j$. These acknowledge that some states have higher rates of goal achievement than others.

-   The state-specific intercepts $B_{0j}$ are assumed to be Normally distributed around some global intercept $\beta_0$ with standard deviation $\sigma_0$. Thus, $\beta_0$ describes the typical baseline success rate across all expeditions and $\sigma_0$ captures the **between-group variability** in success rates from state to state.

-   $\beta_1$ describes the **global** relationship between achievement and householder marriage when controlling for all other variables in the model.

## Results
